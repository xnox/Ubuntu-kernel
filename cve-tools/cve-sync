#!/bin/bash

here=`dirname $0`
case "$here" in
/*) ;;
*)  here="`pwd`/$here" ;;
esac

sha1="[0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f]"
sha1="$sha1[0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f]"
sha1="$sha1[0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f]"
sha1="$sha1[0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f]"

for cvefile in "$@"
do
	cve=`basename "$cvefile"`

	echo "CVE: $cve"

	commits_raw=`sed -n -e 's@^ upstream: http://git.kernel.org/.*[/=]\\('"$sha1"'\\)@\\1@p' <"$cvefile"`
	if [ "$commits_raw" = "" ]; then
		continue
	fi
	commits=''
	for commit in $commits_raw
	do
		commits="$commits $commit"
	done

	echo "CVE: $cve$commits"

	"$here/cve-applied" $commits | \
		sed -e 's/-rc/~rc/g' | \
		"$here/cve-tracker-update" "$cvefile"
done
