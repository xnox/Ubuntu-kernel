#!/bin/bash

here=`dirname $0`
case "$here" in
/*) ;;
*)  here="`pwd`/$here" ;;
esac

repos="$HOME/cve-autotriage"

cache="$1"
overlay="$2"
shift 2

case "$overlay" in
/*) ;;
*)  overlay="`pwd`/$overlay" ;;
esac
shift

cve_list_cache="$cache/CVE-list"
cves_changed=1

cve_list="/tmp/cve-commits.$$"
branch_id="/tmp/cve-branch.$$"
{
	echo "*** enumerating cve commits ..." 1>&2
	"$here/cves-commits" "$@" >"$cve_list"

	if [ -f "$cve_list_cache" ]; then
		if cmp -s "$cve_list_cache" "$cve_list"; then
			cves_changed=0
			echo "NOTE: CVE list unchanged" 1>&2
		else
			echo "NOTE: CVE list changed" 1>&2
		fi
	fi

	echo "*** checking linus master ..." 1>&2
	(
		cd "$repos/linux-linus" || exit 1
		git fetch origin 1>&2
		{
			git show origin/master | head -1
			git tag -l
			echo "" | md5sum "$overlay"
		} >"$branch_id"
		state="$cache/linux-linus"
		branch_changed=1
		if [ -f "$state" ] && cmp -s "$state" "$branch_id"; then
			branch_changed=0
		fi
		if [ "$cves_changed" = 1 -o "$branch_changed" = 1 ]; then
			echo "NOTE: linux-linus changed" 1>&2
			"$here/cves-applied" <"$cve_list" "$overlay" 'linus master' \
				$("$here/cves-git-tags-order" \
					`git tag -l 'v*' | grep -v v2.6.11 | \
						awk '{
							x=$1;
							sub("^v", "", x);
							gsub("-rc", "~rc", x);
							print $1 " " x
						}'
					`
				) "master" "pending" | \
				tee "$state+cache"
			mv "$branch_id" "$state"
		else
			echo "NOTE: linux-linus unchanged" 1>&2
			cat "$state+cache"
		fi
	)

	prev_repo=""
	while read series cvebranch repo branch versions
	do
		echo "*** checking $series $cvebranch ($versions) ... " 1>&2
		(
			cd "$repos/$repo" || exit 1
			[ "$prev_repo" != "$repo" ] && git fetch origin 1>&2
			tag_list=`"$here/cves-git-tags" $versions`
			{
				git show "origin/$branch" | head -1
				echo "$tag_list"
				echo "" | md5sum "$overlay"
			} >"$branch_id"
			state="$cache/$repo-$branch"
			branch_changed=1
			if [ -f "$state" ] && cmp -s "$state" "$branch_id"; then
				branch_changed=0
			fi
			if [ "$cves_changed" = 1 -o "$branch_changed" = 1 ]; then
				echo "NOTE: $series $branch changed" 1>&2
				"$here/cves-applied" <"$cve_list" "$overlay" \
					"$series $cvebranch" \
					$tag_list "origin/$branch" "pending" | \
					tee "$state+cache"

				mv "$branch_id" "$state"
			else
				echo "NOTE: $series $cvebranch unchanged" 1>&2
				cat "$state+cache"
			fi
		)
		prev_repo="$repo"
	done <<EOB
hardy linux ubuntu-hardy master-next 2.6.24-0
lucid linux ubuntu-lucid master-next 2.6.32-0
lucid linux-ec2 ubuntu-lucid ec2 2.6.32-300
lucid linux-fsl-imx51 ubuntu-lucid fsl-imx51 2.6.31-600
lucid linux-lts-backport-natty ubuntu-lucid lts-backport-natty 2.6.38-0
lucid linux-lts-backport-oneiric ubuntu-lucid lts-backport-oneiric 3.0.0-0
natty linux ubuntu-natty master-next 2.6.37-0 2.6.38-0
natty linux-ti-omap4 ubuntu-natty ti-omap4 2.6.38-1200
oneiric linux ubuntu-oneiric master-next 2.6.39-0 3.0-0 3.0.0-0
oneiric linux-ti-omap4 ubuntu-oneiric ti-omap4 2.6.38-1300 3.0.0-1200
precise linux ubuntu-precise master-next 3.1.0-0 3.2.0-0
precise linux-ti-omap4 ubuntu-precise ti-omap4 3.0.0-1400 3.2.0-1400
precise linux-armadaxp ubuntu-precise-armadaxp master 3.2.0-1600
quantal linux ubuntu-quantal master-next 3.4.0-0 3.5.0-0
quantal linux-ti-omap4 ubuntu-quantal ti-omap4 3.4.0-0 3.5.0-0
quantal linux-armadaxp ubuntu-quantal-armadaxp master 3.5.0-1600
raring linux ubuntu-raring master 3.7.0-0
EOB
}

mv "$cve_list" "$cve_list_cache"
rm -f "$cve_list" "$branch_id"
