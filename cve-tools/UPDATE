#!/bin/bash

here=`dirname $0`
case "$here" in
/*) ;;
*)  here="`pwd`/$here" ;;
esac

slow=
if [ "$1" = "--quick" ]; then
	slow=:
fi

$slow echo "*** fetching kernel changes ..."
$slow bzr pull || exit 1

$slow echo "*** fetching upstream changes ..."
$slow bzr pull lp:ubuntu-cve-tracker || bzr merge lp:ubuntu-cve-tracker
$slow bzr commit -m 'update from upstream'

echo "*** scanning git repositories ..."
$here/cves-sync $here/linux-overlay active/CVE-????-????

echo "*** applying rebases ..."
$here/cves-rebase-transfer active/CVE-????-???? | \
	$here/cves-tracker-update --rebase

bzr commit -m 'autotriage'

#bzr push
